require 'spec_helper'

describe Tapyrus::Message::Block do
  describe 'parse from payload' do
    subject do
      Tapyrus::Message::Block.parse_from_payload(
        '010000006c281f247858b3a15a883883f3b6c088a0e933d97bc47688e504f5be9f2cee77e476dba79e75fc0263c917d2ab40a34c1ab7510aba4020d79fa9ad3cfb3ae834c716cff6adf31e2846e905d391f89b3ca81273db405ad1ca0945b79f2c795e023cc3bc5e0040352d6ca481aeab106383da215e05109fa9167ec8284a8e0864905a990f3a1fb67d4a3d4c2111d51c3d9597a5ebd5f466b7959e80250edaf43b62978389d8e86701010000000100000000000000000000000000000000000000000000000000000000000000000300000003530101ffffffff0100f2052a010000001976a9146713b478d99432aac667b7d8e87f9d06edca03bb88ac00000000'
          .htb
      )
    end
    it 'should be parsed' do
      expect(subject.header.block_hash).to eq('052a5cfed3a398991b1318f0db80730778dbdb9830d753f712dfa798a6505e7c')
      expect(subject.transactions.length).to eq(1)
      expect(subject.transactions.first.txid).to eq('025e792c9fb74509cad15a40db7312a83c9bf891d305e946281ef3adf6cf16c7')
    end
  end

  describe 'to_pkt' do
    context 'not use segwit' do
      subject do
        h =
          Tapyrus::BlockHeader.parse_from_payload(
            '010000006c281f247858b3a15a883883f3b6c088a0e933d97bc47688e504f5be9f2cee77e476dba79e75fc0263c917d2ab40a34c1ab7510aba4020d79fa9ad3cfb3ae834c716cff6adf31e2846e905d391f89b3ca81273db405ad1ca0945b79f2c795e023cc3bc5e0040352d6ca481aeab106383da215e05109fa9167ec8284a8e0864905a990f3a1fb67d4a3d4c2111d51c3d9597a5ebd5f466b7959e80250edaf43b62978389d8e867'
              .htb
          )
        b = Tapyrus::Message::Block.new(h)
        tx =
          Tapyrus::Tx.parse_from_payload(
            '010000000100000000000000000000000000000000000000000000000000000000000000000300000003530101ffffffff0100f2052a010000001976a9146713b478d99432aac667b7d8e87f9d06edca03bb88ac00000000'
              .htb
          )
        b.transactions << tx
        b.to_pkt
      end
      it 'should be generate' do
        expect(subject.bth).to eq(
          '0b110907626c6f636b00000000000000030100005ed8e768010000006c281f247858b3a15a883883f3b6c088a0e933d97bc47688e504f5be9f2cee77e476dba79e75fc0263c917d2ab40a34c1ab7510aba4020d79fa9ad3cfb3ae834c716cff6adf31e2846e905d391f89b3ca81273db405ad1ca0945b79f2c795e023cc3bc5e0040352d6ca481aeab106383da215e05109fa9167ec8284a8e0864905a990f3a1fb67d4a3d4c2111d51c3d9597a5ebd5f466b7959e80250edaf43b62978389d8e86701010000000100000000000000000000000000000000000000000000000000000000000000000300000003530101ffffffff0100f2052a010000001976a9146713b478d99432aac667b7d8e87f9d06edca03bb88ac00000000'
        )
      end
    end
  end
end
